

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta property="og:title" content="4. Exploratory analysis - multiple glaciers" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://e-marshall.github.io/itslive/nbs/4_exploratory_data_analysis_group.html" />
<meta property="og:site_name" content="Python" />
<meta property="og:description" content="Introduction: The previous notebooks in this tutorial demonstrated how to use Xarray to access, inspect, manipulate and analyze raster time series data at the scale of an individual glacier. In thi..." />
<meta property="og:image" content="https://e-marshall.github.io/itslive/_static/itslive_explore_img.png" />
<meta property="og:image:alt" content="Python" />
<meta name="description" content="Introduction: The previous notebooks in this tutorial demonstrated how to use Xarray to access, inspect, manipulate and analyze raster time series data at the scale of an individual glacier. In thi..." />

    <title>4. Exploratory analysis - multiple glaciers &#8212; Using xarray to examine cloud-based glacier surface velocity data</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'nbs/4_exploratory_data_analysis_group';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Summary" href="../mds/Summary.html" />
    <link rel="prev" title="3. Exploratory analysis of velocity data – single glacier" href="3_exploratory_data_analysis_single.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../mds/intro.html">
  
  
  
  
  
    <p class="title logo__title">Using xarray to examine cloud-based glacier surface velocity data</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../mds/intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="software_and_data.html">Software and Data</a></li>

<li class="toctree-l1"><a class="reference internal" href="1_accessing_itslive_s3_data.html">1. Accessing cloud-hosted ITS_LIVE data</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_data_organization_manipulation.html">2. Data organization and manipulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_exploratory_data_analysis_single.html">3. Exploratory analysis of velocity data – single glacier</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">4. Exploratory analysis - multiple glaciers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mds/Summary.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mds/Acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mds/Contributing.html">Contributing and Seeking help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mds/References.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/e-marshall/itslive/master?urlpath=lab/tree/nbs/4_exploratory_data_analysis_group.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/e-marshall/itslive" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/e-marshall/itslive/issues/new?title=Issue%20on%20page%20%2Fnbs/4_exploratory_data_analysis_group.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/nbs/4_exploratory_data_analysis_group.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>4. Exploratory analysis - multiple glaciers</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outline">Outline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-read-organize-data">A. Read + organize data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-combine-raster-and-vector-data-to-create-a-vector-data-cube">B. Combine raster and vector data to create a vector data cube</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-data-analysis-and-visualization">Part 3: Data analysis and visualization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#concepts">Concepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#techniques">Techniques</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">A. Read + organize data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raster-data">1) Raster data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vector-data">2) Vector data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-combine-raster-and-vector-data-into-a-vector-data-cube">B. Combine raster and vector data into a vector data cube</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-vector-data-cube">1) Make vector data cube</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-attribute-data-to-vector-cube">2) Add attribute data to vector cube</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#write-vector-data-cube-to-disk">3) Write vector data cube to disk</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-to-write-vector-data-cube-to-disk">Steps to write vector data cube to disk</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-data-visualization-analysis">C. Data visualization + analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#read-vector-data-cube-into-memory">1) Read vector data cube into memory</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-velocity-data">2) Visualize velocity data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-relationships-between-velocity-and-attribute-data">3) Visualize relationships between velocity and attribute data</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="exploratory-analysis-multiple-glaciers">
<h1>4. Exploratory analysis - multiple glaciers<a class="headerlink" href="#exploratory-analysis-multiple-glaciers" title="Permalink to this headline">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>The previous notebooks in this tutorial demonstrated how to use Xarray to access, inspect, manipulate and analyze raster time series data at the scale of an individual glacier. In this notebook, we shift our focus to a sub-regional scale, looking at all of the glaciers within a given ITS_LIVE data cube. This workflow will draw on elements from the past notebooks while introducing new tools for examining raster data along temporal and spatial dimensions (ie. across multiple glaciers).</p>
</section>
<section id="outline">
<h2>Outline<a class="headerlink" href="#outline" title="Permalink to this headline">#</a></h2>
<section id="a-read-organize-data">
<h3>A. Read + organize data<a class="headerlink" href="#a-read-organize-data" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>Raster data</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>Vector data</p></li>
</ol>
</li>
</ul>
</section>
<section id="b-combine-raster-and-vector-data-to-create-a-vector-data-cube">
<h3>B. Combine raster and vector data to create a <a class="reference external" href="https://r-spatial.org/r/2022/09/12/vdc.html">vector data cube</a><a class="headerlink" href="#b-combine-raster-and-vector-data-to-create-a-vector-data-cube" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>Make a vector data cube</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>Add attribute data to vector cube</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p>Write vector cube to disk</p></li>
</ol>
</li>
</ul>
</section>
<section id="part-3-data-analysis-and-visualization">
<h3>Part 3: Data analysis and visualization<a class="headerlink" href="#part-3-data-analysis-and-visualization" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>Read vector data cube into memory</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>Visualize velocity data</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p>Visualize associations between velocity and attribute data</p></li>
</ol>
</li>
</ul>
</section>
</section>
<section id="learning-goals">
<h2>Learning goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">#</a></h2>
<section id="concepts">
<h3>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Querying and accessing raster data from cloud object storage</p></li>
<li><p>Accessing and manipulating vector data</p></li>
<li><p>Handling coordinate reference information</p></li>
<li><p>Calculating and visualizing summary statistics</p></li>
</ul>
</section>
<section id="techniques">
<h3>Techniques<a class="headerlink" href="#techniques" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Access cloud-hosted <a class="reference external" href="https://zarr.readthedocs.io/en/stable/">Zarr</a> data cubes using <a class="reference external" href="https://xarray.dev/">Xarray</a></p></li>
<li><p>Reading <a class="reference external" href="https://geoparquet.org/">GeoParquet</a> vector data using <a class="reference external" href="https://geopandas.org/en/stable/">GeoPandas</a></p></li>
<li><p>Rasterize vector objects using <span class="xref myst">Geocube</span></p></li>
<li><p>Spatial joins of vector datasets using <a class="reference external" href="https://geopandas.org/en/stable/">GeoPandas</a></p></li>
<li><p>Using <a class="reference external" href="https://www.dask.org/">dask</a> to work with out-of-memory data</p></li>
<li><p>Calculating summary statistics of <a class="reference external" href="https://xarray.dev/">Xarray</a> and <a class="reference external" href="https://pandas.pydata.org/">Pandas</a> objects</p></li>
<li><p>Data visualization using <a class="reference external" href="https://pandas.pydata.org/">Pandas</a></p></li>
<li><p>Interactive data visualization with <a class="reference external" href="https://geopandas.org/en/stable/">GeoPandas</a></p></li>
</ul>
<p>Expand the next cell to see specific packages used in this notebook and relevant system and version information.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">xmode</span> minimal

<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">cx</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rxr</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">xvec</span>

<span class="kn">import</span> <span class="nn">itslivetools</span>
    
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format=&#39;retina&#39;
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception reporting mode: Minimal
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">ModuleNotFoundError</span>: No module named &#39;itslivetools&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id1">
<h2>A. Read + organize data<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<section id="raster-data">
<h3>1) Raster data<a class="headerlink" href="#raster-data" title="Permalink to this headline">#</a></h3>
<p>As in past notebooks, we use <code class="docutils literal notranslate"><span class="pre">itslivetools.find_granule_by_point()</span></code> to query the ITS_LIVE catalog for the correct url.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">itslive_catalog</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;https://its-live-data.s3.amazonaws.com/datacubes/catalog_v02.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="n">itslivetools</span><span class="o">.</span><span class="n">find_granule_by_point</span><span class="p">([</span><span class="mf">95.180191</span><span class="p">,</span> <span class="mf">30.645973</span><span class="p">])</span>
<span class="n">url</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;itslivetools&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Following the example shown in the initial data inspection <span class="xref myst">notebook</span>, we read the data in <em>without</em> dask at first so that we can lazily organize the dataset in chronological order</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">itslivetools</span><span class="o">.</span><span class="n">read_in_s3</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">chunks_arg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;mid_date&#39;</span><span class="p">)</span>
<span class="n">dc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;itslivetools&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span><span class="o">.</span><span class="n">data_vars</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
<span class="n">dc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;M11&#39;</span><span class="p">]</span>
<span class="n">dc</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;mid_date&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now we add a chunking scheme, converting the underlying Numpy arrays to Dask arrays.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#First, check the preffered chunk sizes</span>
<span class="n">dc</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encoding</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Then, chunk dataset</span>
<span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;mid_date&#39;</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span>
               <span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We’ll resample the time series to 3-month resolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc_resamp</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">mid_date</span><span class="o">=</span><span class="s1">&#39;3ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                        
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Create a <code class="docutils literal notranslate"><span class="pre">crs</span></code> object based on the <code class="docutils literal notranslate"><span class="pre">projection</span></code> data variable of the data cube (<code class="docutils literal notranslate"><span class="pre">dc</span></code>) object. We’ll use this later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;EPSG:</span><span class="si">{</span><span class="n">dc</span><span class="o">.</span><span class="n">projection</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="vector-data">
<h3>2) Vector data<a class="headerlink" href="#vector-data" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">se_asia</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;data/rgi7_region15_south_asia_east.parquet&#39;</span><span class="p">)</span>
<span class="n">se_asia</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">FileNotFoundError</span>: data/rgi7_region15_south_asia_east.parquet
</pre></div>
</div>
</div>
</div>
<p>What coordinate reference system is this dataframe in?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">se_asia</span><span class="o">.</span><span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;se_asia&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The vector dataset is in WGS 84, meaning that its coordinates are in degrees latitude and longitude rather than meters N and E. We will project this dataset to match the projection of the raster dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">se_asia_prj</span> <span class="o">=</span> <span class="n">se_asia</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;se_asia&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">se_asia_prj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;se_asia_prj&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The vector dataframe representing glacier outlines is very large. For now, we’re only interested in glaciers that lie within the footprint of the ITS_LIVE granule we’re working with and that are larger than 5 square kilometers in area. We subset the full dataset to match those conditions:</p>
<p>To start with, we will look only at glaciers larger in area than 5km2. Subset the dataset to select for those glaciers; start by making a GeoDataFrame of the ITS_LIVE granule footprint in order to perform a spatial join and select only the glaciers from the RGI dataframe (<code class="docutils literal notranslate"><span class="pre">se_asia_prj</span></code>) that are within the granule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc_bbox</span> <span class="o">=</span> <span class="n">itslivetools</span><span class="o">.</span><span class="n">get_bounds_polygon</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
<span class="n">dc_bbox</span><span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Footprint of ITS_LIVE granule&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;itslivetools&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Spatial join</span>
<span class="n">rgi_subset</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">se_asia_prj</span><span class="p">,</span> 
                         <span class="n">dc_bbox</span><span class="p">,</span>
                         <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="c1">#Select only glaciers where area &gt;= 5 km2</span>
<span class="n">rgi_subset</span> <span class="o">=</span> <span class="n">rgi_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rgi_subset</span><span class="p">[</span><span class="s1">&#39;area_km2&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">5.</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;se_asia_prj&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now, we are looking at </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rgi_subset</span><span class="p">)</span><span class="si">}</span><span class="s1"> glaciers.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;rgi_subset&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="b-combine-raster-and-vector-data-into-a-vector-data-cube">
<h2>B. Combine raster and vector data into a vector data cube<a class="headerlink" href="#b-combine-raster-and-vector-data-into-a-vector-data-cube" title="Permalink to this headline">#</a></h2>
<p>Vector data cubes are a data structure similar to a raster data cube, but with a dimension represented by an array of geometries. For a detailed explanation of vector data cubes, see Edzer Pebesma’s <a class="reference external" href="https://r-spatial.org/r/2022/09/12/vdc.html">write-up</a>. <a class="reference external" href="https://xvec.readthedocs.io/en/stable/">Xvec</a> is a relatively new Python package that implements vector data cubes within the Xarray ecosystem. This is an exciting development that can drastically simplify workflows that examine data along both spatial and temporal dimensions and involve spatial features represented by vector points, lines and polygons.</p>
<p>To explain this in more detail, we currently have a raster data cube (the ITS_LIVE time series) that covers the entire spatial footprint shown in blue below. However, the locations in which we are interested in this data are the glaciers outlined in red. Working with this data as a 3-dimensional vector cube is not a very efficient way of accessing the data at the locations shown in red.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">dc_bbox</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">rgi_subset</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">,</span> 
               <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">Esri</span><span class="o">.</span><span class="n">WorldImagery</span><span class="p">,)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Spatial extent of ITS_LIVE granule, shown in blue </span><span class="se">\n</span><span class="s1"> outlines of glaciers of interest, shown in red.&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc_bbox&#39; is not defined
</pre></div>
</div>
<img alt="../_images/f203a7e5f7a327f8841584cfba1312b69faf379df7cfc45e69f7d5a06062d0e0.png" src="../_images/f203a7e5f7a327f8841584cfba1312b69faf379df7cfc45e69f7d5a06062d0e0.png" />
</div>
</div>
<p>Instead, we use the <a class="reference external" href="https://xvec.readthedocs.io/en/stable/zonal_stats.html"><code class="docutils literal notranslate"><span class="pre">Xvec.zonal_stats()</span></code></a> method to convert the 3-dimensional cube to a 2-dimensional cube that has  time dimesnion and a geometry dimension. Each element of the geometry dimension is a glacier from the <code class="docutils literal notranslate"><span class="pre">rgi_subset</span></code> dataframe.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because we are working with polygon geometries, we use zonal_stats() which performs a reduction over the area of the polygon. If our vector data was made up of point features, we could use <a class="reference external" href="https://xvec.readthedocs.io/en/stable/extract_pts.html"><code class="docutils literal notranslate"><span class="pre">Xvec.extract_points()</span></code></a></p>
</div>
<section id="make-vector-data-cube">
<h3>1) Make vector data cube<a class="headerlink" href="#make-vector-data-cube" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;array.slicing.split_large_chunks&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">vector_data_cube</span> <span class="o">=</span> <span class="n">dc_resamp</span><span class="o">.</span><span class="n">xvec</span><span class="o">.</span><span class="n">zonal_stats</span><span class="p">(</span><span class="n">rgi_subset</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                                       <span class="n">x_coords</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y_coords</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;dc_resamp&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_data_cube</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;vector_data_cube&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Great, now we’ve gone from a 3-d object with (mid_date,x,y) dimensions to a 2-d object with (mid_date, geometry) dimensions. However, in addition to the geometry data stored in the vector dataframe, we’d also like to add some of the attribute data to the ITS_LIVE time series vector cube. The following cell adds attributes as coordinate variables to the vector data cube.</p>
</section>
<section id="add-attribute-data-to-vector-cube">
<h3>2) Add attribute data to vector cube<a class="headerlink" href="#add-attribute-data-to-vector-cube" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Define attributes to be added</span>
<span class="n">rgi_attrs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RGIId&#39;</span><span class="p">:</span> <span class="s1">&#39;rgi_id&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Area_km2&#39;</span><span class="p">:</span> <span class="s1">&#39;area_km2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Slope_deg&#39;</span><span class="p">:</span> <span class="s1">&#39;slope_deg&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">update_cube_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">attrs_dict</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;geometry&#39;</span><span class="p">),</span> <span class="n">gdf</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="n">k</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">ds</span>

<span class="n">vector_data_cube</span> <span class="o">=</span> <span class="n">update_cube_attrs</span><span class="p">(</span><span class="n">vector_data_cube</span><span class="p">,</span> <span class="n">rgi_subset</span><span class="p">,</span> <span class="n">rgi_attrs_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;vector_data_cube&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_data_cube</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;vector_data_cube&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-vector-data-cube-to-disk">
<h3>3) Write vector data cube to disk<a class="headerlink" href="#write-vector-data-cube-to-disk" title="Permalink to this headline">#</a></h3>
<p>Later in this notebook, we will want to perform operations that require this object to be loaded into memory. All of our steps thus far have happened lazily, and when we do load the data into memory it will be quite time-consuming.</p>
<p>To skip this step, I’ve loaded the data into memory and written it to disk. This allows us to read the vector data cube (which is much more manageable) into memory from file.</p>
<p>Because this step is quite computationally intensive, I won’t execute it here, but I will include the code for the sake of completeness.</p>
<section id="steps-to-write-vector-data-cube-to-disk">
<h4>Steps to write vector data cube to disk<a class="headerlink" href="#steps-to-write-vector-data-cube-to-disk" title="Permalink to this headline">#</a></h4>
<ol class="arabic">
<li><p>Encode vector data code geometries as [CF] geometries.
This is required because Shapely geometries (how geometries are represented in memory) are not compatible with array-based file formats such as Zarr. To get around this, Xvec uses a package called cf-xarray to encode the Shapely geometries as CF geometries. For more detail on reading and writing vector data cubes, see the Xvec <a class="reference external" href="https://xvec.readthedocs.io/en/stable/io.html">documentation</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">encoded_vdc</span> <span class="o">=</span> <span class="n">vector_data_cube</span><span class="o">.</span><span class="n">xvec</span><span class="o">.</span><span class="n">encode_cf</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Write encoded data cube to Zarr (<em>This triggers <code class="docutils literal notranslate"><span class="pre">.compute()</span></code>, loading the data into memory before writing it to disk.</em> On my computer, this took about 12 minutes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>

    <span class="n">encoded_vdc</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="s1">&#39;data/regional_glacier_velocity_vector_cube.zarr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:
[########################################] | 100% Completed | 12m 15s</p>
</li>
</ol>
</section>
</section>
</section>
<section id="c-data-visualization-analysis">
<h2>C. Data visualization + analysis<a class="headerlink" href="#c-data-visualization-analysis" title="Permalink to this headline">#</a></h2>
<section id="read-vector-data-cube-into-memory">
<h3>1) Read vector data cube into memory<a class="headerlink" href="#read-vector-data-cube-into-memory" title="Permalink to this headline">#</a></h3>
<p>The vector data cube is stored on disk with CF geometries. We go through the reverse of the process we used to write the object to disk, decoding the CF geometries to Shapely geometries with <code class="docutils literal notranslate"><span class="pre">xvec.decode_cf()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_data_cube_cf</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="s1">&#39;data/regional_glacier_velocity_vector_cube.zarr&#39;</span><span class="p">)</span>
<span class="n">vector_data_cube</span> <span class="o">=</span> <span class="n">vector_data_cube_cf</span><span class="o">.</span><span class="n">xvec</span><span class="o">.</span><span class="n">decode_cf</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">KeyError</span>: &#39;.zmetadata&#39;


<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">GroupNotFoundError</span>: group not found at path &#39;&#39;


<span class="n">The</span> <span class="n">above</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">the</span> <span class="n">direct</span> <span class="n">cause</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span> <span class="n">exception</span><span class="p">:</span>

<span class="ne">FileNotFoundError</span>: No such file or directory: &#39;/home/runner/work/itslive/itslive/nbs/data/regional_glacier_velocity_vector_cube.zarr&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-velocity-data">
<h3>2) Visualize velocity data<a class="headerlink" href="#visualize-velocity-data" title="Permalink to this headline">#</a></h3>
<p>Xvec has a method, <code class="docutils literal notranslate"><span class="pre">to_geodataframe()</span></code> that allows us to easily convert the <code class="docutils literal notranslate"><span class="pre">xr.Dataset</span></code> vector cube to a <code class="docutils literal notranslate"><span class="pre">gpd.GeoDataFrame</span></code>. We can then use the GeoPandas <code class="docutils literal notranslate"><span class="pre">.explore()</span></code> method to interactively visualize the data.</p>
<p>We will look at mean velocities over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_data_cube_mean</span> <span class="o">=</span> <span class="n">vector_data_cube</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;mid_date&#39;</span><span class="p">)</span>

<span class="n">vector_data_cube_mean</span><span class="p">[</span><span class="s1">&#39;vmag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vector_data_cube_mean</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vector_data_cube_mean</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">vector_data_cube_mean</span><span class="p">[</span><span class="s1">&#39;vmag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xvec</span><span class="o">.</span><span class="n">to_geodataframe</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="s1">&#39;vmag&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;vector_data_cube&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We could also look at single seasons:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_cube_seasonal_mean</span> <span class="o">=</span> <span class="n">vector_data_cube</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mid_date.season&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">vector_cube_seasonal_mean</span><span class="p">[</span><span class="s1">&#39;vmag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vector_cube_seasonal_mean</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vector_cube_seasonal_mean</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">vector_cube_seasonal_mean</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">season</span><span class="o">=</span><span class="s1">&#39;JJA&#39;</span><span class="p">)[</span><span class="s1">&#39;vmag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xvec</span><span class="o">.</span><span class="n">to_geodataframe</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="s1">&#39;vmag&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;vector_data_cube&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-relationships-between-velocity-and-attribute-data">
<h3>3) Visualize relationships between velocity and attribute data<a class="headerlink" href="#visualize-relationships-between-velocity-and-attribute-data" title="Permalink to this headline">#</a></h3>
<p>In addition to using GeoPandas plotting features, we can still use Xarray’s built in plotting features to visualize the non-spatial elements of the data. Below, we visualize the relationships between magnitude of velocity (y-axis), glacier slope (x-axis) and glacier area (hue).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean velocity in the context of glacier area and slope&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">vector_data_cube_mean</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;Slope_deg&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;vmag&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Area_km2&#39;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Glacier area (sq. km.)&#39;</span><span class="p">})</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude of velocity (m/yr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Glacier slope (degrees)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">NameError</span>: name &#39;vector_data_cube_mean&#39; is not defined
</pre></div>
</div>
<img alt="../_images/c30776b6ad9353879fb2f3628d02a3f1a645e548f3a1d3600285d60c6763d124.png" src="../_images/c30776b6ad9353879fb2f3628d02a3f1a645e548f3a1d3600285d60c6763d124.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="3_exploratory_data_analysis_single.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">3. Exploratory analysis of velocity data – single glacier</p>
      </div>
    </a>
    <a class="right-next"
       href="../mds/Summary.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Summary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outline">Outline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-read-organize-data">A. Read + organize data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-combine-raster-and-vector-data-to-create-a-vector-data-cube">B. Combine raster and vector data to create a vector data cube</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-data-analysis-and-visualization">Part 3: Data analysis and visualization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#concepts">Concepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#techniques">Techniques</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">A. Read + organize data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raster-data">1) Raster data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vector-data">2) Vector data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-combine-raster-and-vector-data-into-a-vector-data-cube">B. Combine raster and vector data into a vector data cube</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-vector-data-cube">1) Make vector data cube</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-attribute-data-to-vector-cube">2) Add attribute data to vector cube</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#write-vector-data-cube-to-disk">3) Write vector data cube to disk</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-to-write-vector-data-cube-to-disk">Steps to write vector data cube to disk</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-data-visualization-analysis">C. Data visualization + analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#read-vector-data-cube-into-memory">1) Read vector data cube into memory</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-velocity-data">2) Visualize velocity data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-relationships-between-velocity-and-attribute-data">3) Visualize relationships between velocity and attribute data</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By emma marshall
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>